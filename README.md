# Межсетевой шлюз GW-MORO (документ в процессе разработки)

## Краткое описание (версия mb_sp33)

GW-MORO — это программно-аппаратный межсетевой шлюз для преобразования данных между различными сетевыми протоколами. Устройство обеспечивает безопасное и надежное взаимодействие сетей с разной архитектурой, поддерживает Modbus и специализированный SP-протокол, а также обладает возможностями WiFi-подключения.

### Основные возможности
- Преобразование данных между Modbus и SP-протоколом
- Встроенная система хранения параметров в NVS

### Не подключены, но частично тенстированы
- Поддержка WiFi-подключения в режимах STA и AP
- Веб-интерфейс для управления и мониторинга
- Механизмы безопасности и шифрования трафика
- Поддержка OTA-обновлений

## Навигация по документации

### Техническая документация
- [Схемы подключения](documents/schematics/)
- [Протоколы связи](documents/protocols/)
- [API-документация](documents/api/)
- [Руководство по настройке](documents/configuration/)

### Эксплуатация
- [Руководство пользователя](documents/user_manual/)
- [Часто задаваемые вопросы](documents/faq/)
- [История изменений](documents/changelog/)

## Руководство пользователя

### Целевой прибор
- **Модель**: СПТ961.1  
- **Артикул**: СП4: 2060100009 - по дефолту будут реализованы соответствующие параметры обмена

### Подключение
1. **P1** - Интерфейс Modbus:
   - A: Линия данных A
   - COM: Общая земля
   - B: Линия данных B
2. **P2** - Интерфейс СПТ:
   - A: Линия A
   - B: Линия B
3. **P3** - Питание +24В
4. **P4** - Подключение UART терминала
5. **P5** - Подключение логического анализатора
6. **P6** - Подключение согласующего резистора 120 Ом

### Поддерживаемые команды Modbus
- `0x03` - Чтение регистров хранения
- `0x06` - Запись одного регистра  
- `0x10` - Запись нескольких регистров

---

## Руководство по настройке

### Базовая конфигурация
1. Подключите питание +24В к разъему P3

2. Настройте параметры связи через регистры Modbus:
   - 0x01 - адрес slave (регистр 0x01);
   - 0x02 - cкорость обмена (индексный ввод, 05h соответствует 9600 бод - по дефолту);
   - 0x03 - Таймаут ответа (время между пакетами в мс; 4мс - по дефолту).

3. **Настройте параметры связи с целевым прибором**:
   - 0x04 - DAD-адрес приемника (в соответствии с настройками целевого прибора)
   - 0x05 - SAD-адрес источника (назначенный данному шлюзу в сети Sp) 
   - 0x06 - Скорость обмена (индексный ввод, 09h соответствует 115200 бод - по дефолту)
   - 0x07 - Таймаут (время между пакетами в мс; 10мс - по дефолту)

4. **Резерв**
   - 0x08 - резервный, не используется;

5. **WiFi - полностью не тестирован**:
   - 0x09 - Режим работы (       )

### Важные замечания
- В регистре 0x00 задаётся номер версии прошивки - при изменении после рестарта будет 
  восстановлена конфигурация разработчика (дефолтные настройки);
- Перед изменением настроек сохраните текущую конфигурацию;
- Изменения вступают в силу после перезагрузки устройства;
- Рекомендуется проверить связь после изменения параметров.

### Диагностика
- Используйте светодиодную индикацию для определения состояния:
  - Зеленый: нормальная работа (пока не используется);
  - Красный: ошибка связи (пока не используется);
  - Синий: активный обмен данными.
- Основная диагностическая информация выводится через терминал
  - подключение покупного модуля UART-USB к P4;
- на P5 через 8-канальный логический анализатор выводятся:
   1. MDI - вход modbus-приёмника
   2. MRO - выход modbus-передатчика
   3. MRS/DE - управление приёмо-передатчиком modbus
   4. SDI - вход sp-приёмника
   5. SRO - выход sp-передатчика
   6. SRS/DE - управление приёмо-передатчиком sp
   7. FB - флаг B
   8. FA - флаг A

Полная техническая документация доступна в соответствующих разделах.

### Тестовый запуск
- СПТ переводится в режим СП4: 2060100009;
- в терминальной программе устанавливаются параметры: адрес 01, 8бит, 1 стоповый, без проверки, 9600 бод и время 
  ожидания ответа (например 600 мс);
- производится подключение COM-порта;
- выбирается режим запись нескольких регистров (0x10), начальный адрес (0x20) и любые значения регистров;
- активизируется запись в регистры с подтверждением записи;
- выбирается режим чтения нескольких регистров (0x03), начальный адрес (0x20) и количество регистров чтения;
- в принятом пакете сравните записанные и прочитанные значения.

### Важное замечание: Весь обмен по протоколу MODBUS идёт независимо от реакции целевого прибора, который получив команду вернёт ответ в регистры, которые надо будет прочитать терминальной программой.

### Отправка пакета целевому прибору и чтение ответа производится легко (исходим из того, что в память прибора пакет запроса заранее записан)
1. Прочитаем регистр 0x0B, значение 0xFFFF указывает на готовность.
2. Запишем в регистр 0x0B значение 0xFF20 (0xFF - старший байт, 0x20 - индекс пакета запроса).
3. Дождёмся значение регистра 0x0B станет равно 0xFFFF (иное укажет на ошибку).
4. Прочитаем регистры, начиная с регистра 0x20 (до 96 регистров), там должен быть ответ целевого прибора на запрос чтения параметра `AT*E2IPA`, записанный ранее в память прибора под индексом
0x20 (не путать индекс 0x20 и номер первого регистра ответного пакета 0x20). Ответный пакет 
упакован в соответствии с протоколом MODBUS.

- Выполним п.п. 1 - 4 с той лишь разницей, что в п.2 запишем в регистр 0x0B вместо 0xFF20 
индекс пакета (ID) запроса 0x0020. В регистрах 0x20+ получим результат расшифровки ответа целевого прибора. 
  
### Важное замечание: всего в память прибора может быть внесено 42 (0x00 ... 0x29) запросов (назовём их файлами запросов) с соответствующим индексом. 

### Запись пакета запроса целевому прибору производится посложнее, но делается не часто:
- каждому файлу выделено по 96 байт;
- ввод запроса производится начиная с регистра 0x80;
- заголовок запроса до кода команды целевому прибору вводить не надо, заголовок будет добавлен автоматически;
- если вводится нечётное количество байтов, то последний байт пишется в регистр старшим, а младший заполняется нулём, который будет автоматически исключён при записи;
- для записи файла в регистр 0x0F запишите индекс файла;
- для проверки в регистр 0x0E запишите индекс файла;
- результат прочитайте в регистрах 0x20+, там будет файл запроса, причём первый байт будет содержать длину файла. Ответ может содержать удвоенный размер 96 + 96 байт.

### В память прибора можно завести под тем же ID 42 файла с инструкциями по обработке ответа, полученного от целевого прибора (файлы шаблонов ответа). 

### Запись шаблона производится аналогично записи запроса:
- для записи файла шаблона ответа в регистр 0x0D запишите индекс файла;
- если файла нет или первый байт нулевой, то шаблон не применяется;
- в примере для ID=0x20 записано имя искомого параметра `AT*E2IPA`.

### И это далеко не всё. 
- Интегрирован HTTP-сервер (не тестирован, план см. ниже)
   с поддержкой:
   - динамических тегов с историей значений;
   - HTTP API для доступа к данным;
   - автоматического управления WiFi подключениями;
   - защитой от ошибок и сбоев;
   - диагностики и мониторинга состояния системы. 


## Аппаратная часть
- Процессор: ESP32
- Интерфейсы: 2× UART, WiFi
- Индикация: RGB-светодиод
- Питание: 24в

## Программное обеспечение
- Основа: FreeRTOS
- Протоколы: Modbus RTU, SP-протокол
- Безопасность: WPA2, шифрование трафика
- Управление:  Modbus-регистры + Веб-интерфейс (резерв)

## Info
PlatformIO IDE for VSCode Version 3.3.4
PLATFORM: Espressif 32 (6.10.0) > Espressif ESP32 Dev Module
HARDWARE: ESP32 240MHz, 320KB RAM, 4MB Flash
Retrieving maximum program size .pio\build\esp32dev\firmware.elf
Checking size .pio\build\esp32dev\firmware.elf
Advanced Memory Usage is available via "PlatformIO Home > Project Inspect"
RAM:   [=         ]  12.8% (used 41820 bytes from 327680 bytes)
Flash: [======    ]  55.5% (used 872672 bytes from 1572864 bytes)

## Быстрый старт
1. Подключите оборудование согласно схеме
2. Настройте Modbus-регистры для работы с целевым прибором

### Как проверить систему (пошаговая инструкция для разработчика ПО):

1. **Проверка работы тегов**:
```bash
# В мониторе ESP-IDF
I (1234) PROCESSING: Пакет успешно обработан
I (1235) DATA_TAGS: Создан новый тег: temperature (история: 100 значений)
I (1236) DATA_TAGS: Обновлено значение temperature: 25.6
```

2. **Проверка WiFi подключения**:
```bash
I (2456) WiFiManager: Switching to STA mode
I (2567) WiFiManager: Found network: MyFactoryWiFi
I (2678) WiFiManager: got ip: 192.168.1.42
```

3. **Тестирование API**:
```bash
# Получение списка тегов
curl http://192.168.1.42/tags

# Пример ответа:
{
  "tags": [
    {"name": "temperature", "value": 25.6},
    {"name": "pressure", "value": 101.3}
  ]
}

# Получение истории
curl http://192.168.1.42/history?name=temperature

# Пример ответа:
{
  "name": "temperature",
  "history": [25.1, 25.2, 25.3, ...],
  "current_index": 42
}
```

4. **Проверка переключения режимов**:
```c
// Через Modbus-регистры
REG_WIFI_MODE = 0; // WiFi OFF
REG_WIFI_MODE = 1; // STA mode
REG_WIFI_MODE = 2; // AP mode
```

### Доработки для промышленного применения:

1. **Безопасность**:
```c
// В http_server.c добавить аутентификацию
static esp_err_t check_auth(httpd_req_t *req)
{
    char username[32], password[32];
    if (httpd_req_get_hdr_value_str(req, "Authorization", auth_buf, sizeof(auth_buf)) {
        // Проверка учетных данных
    }
    return ESP_OK;
}
```

2. **Управление памятью**:
```c
// В data_tags.c добавить
void free_unused_tags()
{
    for (int i = 0; i < tags_count; i++) {
        if (tags[i].last_update < time(NULL) - 86400) { // 24 часа неактивности
            free(tags[i].history);
            // Сдвиг массива
        }
    }
}
```

3. **Диагностика**:
```c
// Новый API для диагностики
curl http://192.168.1.42/diag

// Ответ:
{
  "wifi_mode": "STA",
  "connected_ap": "MyFactoryWiFi",
  "tags_count": 12,
  "memory_used": "45.2KB"
}
```

### Рекомендации по тестированию:

1. **Этап 1: Проверка парсинга данных**
   - Эмулируйте входящие пакеты через UART
   - Убедитесь, что теги создаются и обновляются

2. **Этап 2: Проверка WiFi подключения**
   - Тестируйте все 3 сети STA из конфигурации
   - Проверьте переключение между режимами

3. **Этап 3: Тестирование API**
   - Используйте curl, Postman или браузер
   - Проверьте все эндпоинты: /tags, /history, /value

4. **Этап 4: Стресс-тестирование**
   - 100+ тегов с частым обновлением
   - Длительная работа (24+ часа)
   - Скачки напряжения питания

После этих доработок и тестирования система будет полностью готова к промышленному применению! 💪
 